name: Cleanup Old Releases and Tags

on:
  workflow_dispatch:
    inputs:
      keep_count:
        description: 'Number of releases to keep (most recent)'
        required: false
        type: number
        default: 5
      dry_run:
        description: 'Dry run (only show what would be deleted)'
        required: false
        type: boolean
        default: true

permissions:
  contents: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cleanup releases and tags
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          keep_count=${{ inputs.keep_count }}
          dry_run=${{ inputs.dry_run }}

          gh release list
          
          all_releases=$(gh release list --limit 100 --json tagName --jq '.[].tagName')
          release_types=$(echo "$all_releases" | sed -n 's/.*-\(.*\)$/\1/p' | sort -u)
          
          for type in $release_types; do
            echo "Processing release type: $type"
            
            type_releases=$(echo "$all_releases" | grep -- "-${type}$" || true)
            releases_to_delete=$(echo "$type_releases" | tail -n +$((keep_count + 1)))
            
            for tag in $releases_to_delete; do
              echo "Deleting release: $tag (type: $type)"
              if [ "$dry_run" = "false" ]; then
                gh release delete "$tag" --yes
                gh api --method DELETE "repos/$GITHUB_REPOSITORY/git/refs/tags/$tag" || true
              fi
            done
          done
